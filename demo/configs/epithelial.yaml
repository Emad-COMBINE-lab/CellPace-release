# CellPace Configuration - Epithelial Cells

# ============================================================================
# EXPERIMENT
# ============================================================================
experiment:
  name: cellpace_epithelial
  seed: 42
  output_root: demo/output/epithelial
  vae_to_use: scvi
  vae_dir: ${experiment.output_root}/scvi
  dif_dir: ${experiment.output_root}/dif-${dif.diffusion.objective}/
  device: cuda
  num_workers: 4
  pin_memory: true
  num_gpus: 2
  strategy: auto

# ============================================================================
# DATA
# ============================================================================
data:
  dataset: epithelial
  special_genes_to_include: []

  paths:
    input: demo/data/prcd_epithelial.h5ad
    preprocess_cache: ${experiment.output_root}/data_cache
    dif_seq_cache: ${experiment.dif_dir}/input_seq

  split:
    strategy: stage_holdout

    stage_holdout:
      train: ["somite_00", "somite_02", "somite_03", "somite_04", "somite_05", "somite_07", "somite_08", "somite_09", "somite_14", "somite_16", "somite_17", "somite_20", "somite_21", "somite_23", "somite_24", "somite_25", "somite_26", "somite_27", "somite_28", "somite_29", "somite_30"]
      val_interp: ["somite_10", "somite_11", "somite_22"]
      val_extrap: ["somite_31", "somite_32"]
      test_interp: ["somite_12", "somite_15", "somite_18"]
      test_extrap: ["somite_33", "somite_34"]

  columns:
    stage_real: author_somite_count
    stage_generated: author_somite_count

  n_genes: 3000
  vae_latent_dim: ${scvi.architecture.n_latent}
  vae_use_layer: ${scvi.architecture.use_layer}

  sequences:
    length: 5
    chunk_size: 1
    min_cells_per_stage: 100
    n_sequences: 1000000
    force_regenerate: false

# ============================================================================
# SCVI (VAE)
# ============================================================================
scvi:
  architecture:
    n_hidden: 512
    n_latent: 256
    n_layers: 4
    dropout_rate: 0.1
    gene_likelihood: zinb
    use_layer: raw_counts

  training:
    max_epochs: 400
    batch_size: 256
    learning_rate: 1e-3
    weight_decay: 1e-5
    retrain: false
    early_stopping:
      enabled: True
      patience: 50

# ============================================================================
# DIFFUSION FORCING
# ============================================================================
dif:
  architecture:
    input_dim: ${scvi.architecture.n_latent}
    sequence_length: ${data.sequences.length}
    chunk_size: ${data.sequences.chunk_size}
    external_cond_dim: 0

    gap_modeling:
      enabled: true
      gap_scale: 1.0

    transformer:
      n_layers: 4
      n_heads: 4
      hidden_dim: 128
      feedforward_dim: 512
      dropout: 0.2
      weight_init_std: 0.01

    time_embedding:
      type: sinusoidal
      theta: 10000

    causal: true
    frame_stack: 1
    frame_skip: 0
    context_frames: 1

  training:
    max_steps: 40000
    batch_size: 512
    checkpoint_every: 10000

    loss:
      strategy: snr
      snr_clip: 30.0
      snr_clip_mse: 1000000
      temporal_decay: 1.0

    optimizer:
      type: adamw
      lr: 0.0001711
      lr_min: 1e-6
      weight_decay: 0.0002531
      betas: [0.8832, 0.9902]
      warmup_steps: 1000
      gradient_clip_val: 5.0

  diffusion:
    objective: pred_x0
    logsnr_min: -15.0
    logsnr_max: 15.0
    shift: 1.0
    timesteps: 1000
    sampling_timesteps: 50
    noise_clip: 20.0
    schedule:
      type: cosine
      cosine:
        offset: 0.01
    sampling:
      method: ddim
      eta: 1.0
    stabilization_level: 5

  generation:
    mode: noise_start
    n_samples: 1000
    batch_size: 200
    noise_level: random_all
    scheduling_matrix: pyramid
    uncertainty_scale: 1.0
    context_noise_scale: 0.1

# ============================================================================
# LOGGING
# ============================================================================
logging:
  level: INFO
  save_to_file: true
  wandb:
    enabled: true
    project: cellpace
    entity: null
    mode: offline
    log_frequency: 1000
